<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Character Studio</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Sofia+Sans+Extra+Condensed">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        :root {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --primary-light: #60a5fa;
            --success: #10b981;
            --success-dark: #059669;

            --bg-primary: rgba(12, 12, 12, 0.85);
            --bg-secondary: rgba(25, 25, 25, 0.8);
            --bg-tertiary: rgba(40, 40, 40, 0.8);
            --bg-surface: rgba(55, 55, 55, 0.8);

            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            --text-accent: #3b82f6;

            --hover: rgba(59, 130, 246, 0.1);
            --active: rgba(59, 130, 246, 0.2);
            --focus: rgba(59, 130, 246, 0.3);

            --border-primary: rgba(148, 163, 184, 0.15);
            --border-secondary: rgba(71, 85, 105, 0.2);
            --shadow-xl: 0 10px 25px -5px rgba(0, 0, 0, 0.2);

            --font-primary: 'Inter', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;

            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;

            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-full: 9999px;

            --transition-fast: 150ms ease-out;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-user-drag: none;
            -webkit-touch-callout: none;
        }

        body {
            font-family: var(--font-primary);
            color: var(--text-primary);
            background: transparent;
            min-height: 100vh;
            overflow: hidden;
            padding: var(--spacing-lg);
            line-height: 1.6;
            font-weight: 500;
        }

        .character-studio {
            display: flex;
            width: 420px;
            height: 95vh;
            background: var(--bg-primary);
            border-radius: var(--radius-sm);
            overflow: hidden;
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-primary);
            box-shadow: var(--shadow-xl);
            animation: studioFadeIn 0.4s ease-out;
            flex-direction: column;
            justify-content: space-between;
        }

        @keyframes studioFadeIn {
            from { opacity: 0; transform: scale(0.95) translateX(-20px); }
            to { opacity: 1; transform: scale(1) translateX(0); }
        }

        .sidebar {
            background: transparent;
            border-radius: 0;
            padding: var(--spacing-md);
            padding-bottom: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            flex: 1;
            height: 100%;
        }

        .tab-navigation {
            display: flex;
            background: transparent;
            margin-bottom: var(--spacing-md);
            padding: 0;
        }

        .tab-btn {
            flex: 1;
            padding: var(--spacing-sm) var(--spacing-xs);
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            border-radius: 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid transparent;
        }
        
        .tab-btn:hover {
            color: var(--text-secondary);
        }
        
        .tab-btn.active {
            background: transparent;
            color: var(--text-primary);
            box-shadow: none;
            border-bottom-color: var(--primary);
        }

        .category-navigation {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
            padding: var(--spacing-sm);
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
            margin-bottom: var(--spacing-md);
            max-height: 200px;
            overflow-y: auto;
        }

        .category-navigation::-webkit-scrollbar { width: 4px; }
        .category-navigation::-webkit-scrollbar-track { background: transparent; }
        .category-navigation::-webkit-scrollbar-thumb { background: var(--bg-surface); border-radius: 2px; }

        .category-btn {
            width: 100%;
            height: auto;
            min-height: 36px;
            background: var(--bg-tertiary);
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-md);
            transition: all var(--transition-fast);
            border: 2px solid transparent;
            border-radius: var(--radius-sm);
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .category-btn i {
            font-size: 1rem;
            min-width: 20px;
            text-align: center;
        }

        .category-btn:hover {
            background: var(--bg-surface);
            color: var(--text-primary);
            border-color: var(--border-secondary);
        }

        .category-btn.active {
            background: var(--bg-tertiary);
            color: var(--success);
            border-color: var(--success);
        }

        .content-area {
            flex: 1;
            overflow-y: auto;
            padding-right: var(--spacing-sm);
        }

        .content-area::-webkit-scrollbar { width: 6px; }
        .content-area::-webkit-scrollbar-track { background: transparent; }
        .content-area::-webkit-scrollbar-thumb { background: var(--bg-surface); border-radius: 3px; }
        .content-area::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        .loading { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            padding: var(--spacing-lg); 
            color: var(--text-muted); 
            font-style: italic; 
        }
        
        .spinner { 
            width: 20px; 
            height: 20px; 
            border: 2px solid var(--border-primary); 
            border-top: 2px solid var(--primary); 
            border-radius: 50%; 
            animation: spin 1s linear infinite; 
            margin-right: var(--spacing-sm); 
        }
        
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        
        .category-section {
            margin-bottom: var(--spacing-sm);
        }

        .category-header { 
            display: none; 
        }
        
        .list-item {
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: var(--spacing-sm);
            align-items: center;
            padding: var(--spacing-sm) var(--spacing-md);
            margin-bottom: var(--spacing-xs);
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all var(--transition-fast);
            position: relative;
            border: 1px solid var(--border-primary);
            min-height: 48px;
        }

        .list-item:hover { 
            background: var(--bg-surface); 
            border-color: var(--border-secondary); 
        }

        .list-item.selected { 
            background: var(--primary); 
            border-color: var(--primary-dark); 
            box-shadow: none; 
            color: white;
        }

        .list-item.selected .stepper-value,
        .list-item.selected .item-label,
        .list-item.selected .item-icon {
            color: white;
        }

        .list-item.selected .stepper-btn {
            background: var(--primary-light);
            color: white;
            border-color: var(--primary-light);
        }

        .item-icon {
            font-size: 1.1rem;
            color: var(--text-muted);
            min-width: 24px;
            text-align: center;
        }

        .item-label {
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--text-primary);
            text-align: left;
        }

        .stepper {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            background: var(--bg-surface);
            border-radius: var(--radius-sm);
            border: none;
            overflow: hidden;
            width: fit-content;
        }

        .stepper-btn { 
            width: 28px;
            height: 28px;
            border-radius: var(--radius-sm);
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
            font-size: 0.8rem;
            position: relative;
        }

        .stepper-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .stepper-value {
            min-width: 50px;
            text-align: center;
            font-family: var(--font-mono);
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
            padding: 0 var(--spacing-xs);
            border: none;
        }

        .slider-item {
            flex-direction: column;
            align-items: flex-start;
            padding: var(--spacing-md);
            display: flex;
        }

        .slider-item .item-header {
            width: 100%;
            margin-bottom: var(--spacing-sm);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .item-controls-grid { 
            display: grid; 
            grid-template-columns: 80px 1fr; 
            gap: var(--spacing-sm); 
            align-items: center; 
            width: 100%;
            margin-top: var(--spacing-sm); 
        }
        
        .item-controls-label { 
            font-size: 0.8rem; 
            color: var(--text-muted); 
            font-weight: 500; 
            text-transform: uppercase; 
        }

        .slider-container { 
            width: 100%; 
            height: 32px; 
            display: flex; 
            align-items: center; 
        }
        
        .slider { 
            -webkit-appearance: none; 
            width: 100%; 
            height: 4px; 
            background: var(--bg-tertiary); 
            border-radius: 2px; 
            outline: none; 
            transition: opacity var(--transition-fast); 
        }
        
        .slider::-webkit-slider-thumb { 
            -webkit-appearance: none; 
            appearance: none; 
            width: 16px; 
            height: 16px; 
            background: var(--primary); 
            border-radius: 50%; 
            cursor: pointer; 
            border: 2px solid var(--bg-primary); 
        }
        
        .slider::-moz-range-thumb { 
            width: 16px; 
            height: 16px; 
            background: var(--primary); 
            border-radius: 50%; 
            cursor: pointer; 
            border: 2px solid var(--bg-primary); 
        }

        .cam-controls {
            width: 100%;
            background: #000;
            border-radius: var(--radius-sm);
            margin-top: var(--spacing-md);
            padding: var(--spacing-md);
            border: 1px solid var(--border-primary);
            min-height: 200px;
        }

        .cam-controls-header {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #555;
            margin-bottom: var(--spacing-md);
            text-align: center;
        }

        .cam-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
        }

        .cam-btn {
            aspect-ratio: 1;
            background: rgba(40, 40, 40, 0.6);
            border: 1px solid rgba(80, 80, 80, 0.4);
            border-radius: var(--radius-sm);
            color: rgba(200, 200, 200, 0.6);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all var(--transition-fast);
        }

        .cam-btn:hover {
            background: rgba(60, 60, 60, 0.8);
            color: rgba(59, 130, 246, 0.9);
            border-color: rgba(59, 130, 246, 0.4);
        }

        .cam-btn:active {
            transform: scale(0.95);
        }

        .cam-btn.center-btn {
            background: rgba(50, 50, 50, 0.7);
            font-size: 1rem;
        }

        .cam-presets {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--spacing-xs);
        }

        .cam-preset-btn {
            padding: var(--spacing-sm);
            background: rgba(40, 40, 40, 0.6);
            border: 1px solid rgba(80, 80, 80, 0.4);
            border-radius: var(--radius-sm);
            color: rgba(200, 200, 200, 0.6);
            cursor: pointer;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            transition: all var(--transition-fast);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            min-height: 50px;
        }

        .cam-preset-btn:hover {
            background: rgba(59, 130, 246, 0.3);
            color: rgba(59, 130, 246, 1);
            border-color: rgba(59, 130, 246, 0.5);
        }

        .cam-preset-btn i {
            font-size: 1rem;
        }

        .action-buttons {
            display: flex;
            gap: var(--spacing-sm);
            padding: var(--spacing-md);
            border-top: 1px solid var(--border-primary);
            background: var(--bg-primary);
        }

        .btn {
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--radius-sm);
            border: none;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            flex: 1;
        }

        .btn-primary {
            background: var(--success);
            color: white;
        }

        .btn-primary:hover {
            background: var(--success-dark);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border: 1px solid var(--border-primary);
        }

        .btn-secondary:hover {
            background: var(--bg-surface);
            border-color: var(--border-secondary);
        }

        .btn:disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
            transform: none !important; 
        }

        .action-item {
            grid-template-columns: auto 1fr;
            grid-template-rows: auto auto;
            align-items: start;
        }

        .action-item .item-icon {
            grid-row: 1 / 3;
        }

        .action-item .item-label {
            grid-column: 2;
            grid-row: 1;
        }

        .action-item .item-description {
            grid-column: 2;
            grid-row: 2;
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: var(--spacing-xs);
        }

        .status-message { 
            padding: var(--spacing-sm); 
            border-radius: var(--radius-md); 
            font-size: 0.85rem; 
            font-weight: 500; 
            margin-bottom: var(--spacing-md); 
            text-align: center; 
        }
        
        .status-success { 
            background: rgba(16, 185, 129, 0.1); 
            color: var(--success); 
            border: 1px solid rgba(16, 185, 129, 0.2); 
        }
        
        .status-warning { 
            background: rgba(245, 158, 11, 0.1); 
            color: #f59e0b; 
            border: 1px solid rgba(245, 158, 11, 0.2); 
        }
        
        .status-error { 
            background: rgba(239, 68, 68, 0.1); 
            color: #ef4444; 
            border: 1px solid rgba(239, 68, 68, 0.2); 
        }

    </style>
</head>
<body>
    <div class="character-studio" id="characterStudio">
        
        <div class="sidebar">
            <div class="tab-navigation" id="tabNavigation"></div>
            <div class="category-navigation" id="categoryNavigation"></div>
            <div class="content-area" id="contentArea">
                <div class="loading">
                    <div class="spinner"></div>
                    Loading customization options...
                </div>
            </div>
        </div>

        <div class="action-buttons">
            <button class="btn btn-secondary" id="btnHideClothes">
                <i class="fa-solid fa-eye-slash"></i>
                Hide Clothes
            </button>
            <button class="btn btn-primary" id="btnSave">
                <i class="fa-solid fa-check"></i>
                Save Everything
            </button>
        </div>
    </div>

    <script>
        class CharacterStudio {
            constructor() {
                this.studio = document.getElementById('characterStudio');
                this.tabNavigation = document.getElementById('tabNavigation');
                this.categoryNavigation = document.getElementById('categoryNavigation');
                this.contentArea = document.getElementById('contentArea');
                
                this.currentTab = 'face';
                this.selectedKey = null;
                this.selectedIsVariant = false;
                this.characterData = {};
                this.outfits = [];
                this.pricing = {};

                this.initializeEventListeners();
                this.setupNuiListener();
            }

            initializeEventListeners() {
                this.tabNavigation.addEventListener('click', (e) => {
                    const tabKey = e.target.closest('.tab-btn')?.dataset.tab;
                    if (tabKey) this.switchTab(tabKey);
                });
                
                this.categoryNavigation.addEventListener('click', (e) => {
                    this.handleCategoryClick(e);
                });

                this.contentArea.addEventListener('click', (e) => {
                    this.handleContentClick(e);
                });
                
                this.contentArea.addEventListener('input', (e) => {
                    this.handleSliderInput(e);
                });

                document.getElementById('btnSave').addEventListener('click', () => {
                    this.saveCharacter();
                });

                document.getElementById('btnHideClothes').addEventListener('click', () => {
                    this.sendNuiMessage('toggleClothes');
                });

                document.addEventListener('keydown', (e) => {
                    this.handleKeyboard(e);
                });

                document.addEventListener('click', (e) => {
                    const camBtn = e.target.closest('[data-cam-action]');
                    if (camBtn) {
                        const action = camBtn.dataset.camAction;
                        this.handleCameraAction(action);
                        return;
                    }

                    const presetBtn = e.target.closest('[data-cam-preset]');
                    if (presetBtn) {
                        const preset = presetBtn.dataset.camPreset;
                        this.handleCameraPreset(preset);
                        return;
                    }
                });
            }

            handleCameraAction(action) {
                console.log('Camera action:', action);
                this.sendNuiMessage('cameraAction', { action });
            }

            handleCameraPreset(preset) {
                console.log('Camera preset:', preset);
                this.sendNuiMessage('cameraPreset', { preset });
            }
            
            handleCategoryClick(e) {
                const btn = e.target.closest('.category-btn');
                if (!btn) return;
                const key = btn.dataset.categoryKey;
                if (!key) return;

                this.contentArea.querySelectorAll('.category-section').forEach(sec => {
                    sec.style.display = 'none';
                });
                
                const activeSection = this.contentArea.querySelector(`.category-section[data-category-key="${key}"]`);
                if (activeSection) {
                    activeSection.style.display = 'block';
                }

                this.categoryNavigation.querySelectorAll('.category-btn').forEach(b => {
                    b.classList.remove('active');
                });
                btn.classList.add('active');
            }

            handleContentClick(e) {
                const stepperBtn = e.target.closest('.stepper-btn');
                if (stepperBtn) {
                    const { key, variant } = stepperBtn.dataset;
                    const op = parseInt(stepperBtn.dataset.op, 10);
                    if (key) {
                        this.handleStepperChange(key, variant === 'true', op);
                    }
                    return;
                }
                
                const actionItem = e.target.closest('.action-item');
                if(actionItem) {
                    const action = actionItem.dataset.action;
                    if (action) { this.handleAction(action); }
                    return;
                }

                const listItem = e.target.closest('.list-item');
                if(listItem && !listItem.classList.contains('slider-item')) {
                    const { key, variant } = listItem.dataset;
                    this.selectedKey = key;
                    this.selectedIsVariant = (variant === 'true');
                    this.updateSelection();
                    return;
                }
            }
            
            handleSliderInput(e) {
                if (!e.target.classList.contains('slider')) return;
                
                const key = e.target.dataset.key;
                const type = e.target.dataset.type;
                const value = parseFloat(e.target.value);

                if (!this.characterData[this.currentTab]) {
                    this.characterData[this.currentTab] = {};
                }
                if (!this.characterData[this.currentTab][key]) {
                    this.characterData[this.currentTab][key] = {};
                }

                this.characterData[this.currentTab][key][type] = value;

                this.sendNuiMessage('updateAppearance', {
                    category: this.currentTab,
                    key: key,
                    type: type,
                    value: value
                });

                this.updatePrice();
            }

            handleAction(action) {
                switch(action) {
                    case 'saveOutfit':
                        this.saveOutfit();
                        break;
                    case 'loadOutfit':
                        this.loadOutfit();
                        break;
                }
            }

            handleStepperChange(key, isVariant, operation) {
                if (!this.characterData[this.currentTab]) {
                    this.characterData[this.currentTab] = {};
                }
                if (!this.characterData[this.currentTab][key]) {
                    const itemDef = this.findItemDefinition(key);
                    this.characterData[this.currentTab][key] = {
                        value: itemDef?.default || 0,
                        variant: 0
                    };
                }
                
                const currentItem = this.characterData[this.currentTab][key];
                const itemDef = this.findItemDefinition(key);
                if (!itemDef) return;

                const prop = isVariant ? 'variant' : 'value';
                const maxProp = isVariant ? 'maxVariant' : 'max';

                let currentValue = currentItem[prop] || 0;
                currentValue += operation;

                const maxValue = itemDef[maxProp] || 0;
                const minValue = itemDef.min || 0;

                if (currentValue < minValue) currentValue = maxValue;
                if (currentValue > maxValue) currentValue = minValue;

                currentItem[prop] = currentValue;

                const valueElement = document.getElementById(`${key}-${prop}-value`);
                if (valueElement) {
                    valueElement.textContent = `${currentValue} / ${maxValue}`;
                }

                this.sendNuiMessage('updateAppearance', {
                    category: this.currentTab,
                    key: key,
                    type: prop,
                    value: currentValue
                });

                this.updatePrice();
            }

            findItemDefinition(key) {
                const tabData = this.tabs[this.currentTab];
                if (!tabData) return null;
                for (const cat in tabData.categories) {
                    if (tabData.categories[cat].items[key]) {
                        return tabData.categories[cat].items[key];
                    }
                }
                return null;
            }

            handleKeyboard(e) {
                const items = Array.from(this.contentArea.querySelectorAll('.list-item'));
                let visibleItems = items.filter(item => item.closest('.category-section').style.display !== 'none');
                if (visibleItems.length === 0) return;

                let currentIndex = visibleItems.findIndex(item => 
                    item.dataset.key === this.selectedKey && 
                    (item.dataset.variant === 'true') === this.selectedIsVariant
                );
                if (currentIndex === -1) currentIndex = 0;

                switch (e.key) {
                    case 'ArrowUp':
                        e.preventDefault();
                        currentIndex = (currentIndex - 1 + visibleItems.length) % visibleItems.length;
                        break;
                    case 'ArrowDown':
                        e.preventDefault();
                        currentIndex = (currentIndex + 1) % visibleItems.length;
                        break;
                    case 'Escape':
                        e.preventDefault();
                        this.sendNuiMessage('closeUI');
                        return;
                    default:
                        return;
                }
                
                const newItem = visibleItems[currentIndex];
                if (newItem) {
                    this.selectedKey = newItem.dataset.key;
                    this.selectedIsVariant = (newItem.dataset.variant === 'true');
                    this.updateSelection();
                    newItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            }

            switchTab(tabKey) {
                if (!this.tabs[tabKey]) return;

                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                const activeTab = document.querySelector(`.tab-btn[data-tab="${tabKey}"]`);
                if (activeTab) activeTab.classList.add('active');

                this.currentTab = tabKey;
                this.selectedKey = null;
                this.selectedIsVariant = false;
                this.renderTabContent(tabKey);
            }

            renderTabContent(tabKey) {
                const tabData = this.tabs[tabKey];
                if (!tabData) {
                    this.contentArea.innerHTML = '<div class="loading">No options for this tab.</div>';
                    this.categoryNavigation.innerHTML = '';
                    return;
                }

                let content = '';
                let categoryNavContent = '';
                let isFirstCategory = true;

                for (const categoryKey in tabData.categories) {
                    const categoryData = tabData.categories[categoryKey];
                    if (Object.keys(categoryData.items).length === 0) continue;

                    const categoryIcon = this.getCategoryIcon(categoryKey);
                    const activeClass = isFirstCategory ? 'active' : '';

                    categoryNavContent += `
                        <button class="category-btn ${activeClass}" data-category-key="${categoryKey}">
                            ${categoryIcon}
                            <span>${categoryData.name}</span>
                        </button>
                    `;

                    const displayStyle = isFirstCategory ? 'block' : 'none';
                    content += `
                        <div class="category-section" data-category-key="${categoryKey}" style="display: ${displayStyle};">
                    `;

                    for (const itemKey in categoryData.items) {
                        const item = categoryData.items[itemKey];
                        
                        if (item.type === 'slider') {
                            content += this.renderSliderItem(itemKey, item, categoryKey);
                        } else if (item.type === 'action') {
                            content += this.renderActionItem(item.action, item.name, item.description);
                        } else {
                            content += this.renderListItem(itemKey, item, categoryKey, false);
                            
                            if (item.variant && item.maxVariant > 0) {
                                content += this.renderListItem(itemKey, item, categoryKey, true);
                            }
                        }
                    }

                    content += `</div>`;
                    isFirstCategory = false;
                }

                content += `
                    <div class="cam-controls" id="camControls">
                        <div class="cam-controls-header">Camera Controls</div>
                        
                        <div class="cam-grid">
                            <button class="cam-btn" data-cam-action="rotate-left" title="Rotate Left">
                                <i class="fa-solid fa-arrow-rotate-left"></i>
                            </button>
                            <button class="cam-btn" data-cam-action="zoom-in" title="Zoom In">
                                <i class="fa-solid fa-magnifying-glass-plus"></i>
                            </button>
                            <button class="cam-btn" data-cam-action="rotate-right" title="Rotate Right">
                                <i class="fa-solid fa-arrow-rotate-right"></i>
                            </button>
                            
                            <button class="cam-btn" data-cam-action="pan-up" title="Pan Up">
                                <i class="fa-solid fa-arrow-up"></i>
                            </button>
                            <button class="cam-btn center-btn" data-cam-action="reset" title="Reset Camera">
                                <i class="fa-solid fa-house"></i>
                            </button>
                            <button class="cam-btn" data-cam-action="pan-down" title="Pan Down">
                                <i class="fa-solid fa-arrow-down"></i>
                            </button>
                            
                            <button class="cam-btn" data-cam-action="orbit-left" title="Orbit Left">
                                <i class="fa-solid fa-circle-arrow-left"></i>
                            </button>
                            <button class="cam-btn" data-cam-action="zoom-out" title="Zoom Out">
                                <i class="fa-solid fa-magnifying-glass-minus"></i>
                            </button>
                            <button class="cam-btn" data-cam-action="orbit-right" title="Orbit Right">
                                <i class="fa-solid fa-circle-arrow-right"></i>
                            </button>
                        </div>

                        <div class="cam-presets">
                            <button class="cam-preset-btn" data-cam-preset="front" title="Front View">
                                <i class="fa-solid fa-user"></i>
                                <span>Front</span>
                            </button>
                            <button class="cam-preset-btn" data-cam-preset="back" title="Back View">
                                <i class="fa-solid fa-user" style="transform: scaleX(-1);"></i>
                                <span>Back</span>
                            </button>
                            <button class="cam-preset-btn" data-cam-preset="left" title="Left Side">
                                <i class="fa-solid fa-angles-left"></i>
                                <span>Left</span>
                            </button>
                            <button class="cam-preset-btn" data-cam-preset="right" title="Right Side">
                                <i class="fa-solid fa-angles-right"></i>
                                <span>Right</span>
                            </button>
                        </div>
                    </div>
                `;

                this.categoryNavigation.innerHTML = categoryNavContent;
                this.contentArea.innerHTML = content;
                this.updateSelection();
            }

            renderListItem(key, item, category, isVariant) {
                const prop = isVariant ? 'variant' : 'value';
                const maxProp = isVariant ? 'maxVariant' : 'max';
                
                const itemData = this.characterData[this.currentTab]?.[key] || { value: item.default || 0, variant: 0 };
                const currentValue = itemData[prop];
                const maxValue = item[maxProp] || 0;

                let label = item.name;
                if (isVariant) {
                    label = item.variantLabel || `${item.name} Variant`;
                }

                const itemIcon = this.getItemIcon(key, isVariant);
                const isSelected = (this.selectedKey === key && this.selectedIsVariant === isVariant);
                const selectedClass = isSelected ? 'selected' : '';

                return `
                    <div class="list-item ${selectedClass}" data-key="${key}" data-variant="${isVariant}">
                        <span class="item-icon">${itemIcon}</span>
                        <span class="item-label">${label}</span>
                        <div class="stepper">
                            <button class="stepper-btn" data-key="${key}" data-variant="${isVariant}" data-op="-1" title="Previous">
                                <i class="fa-solid fa-chevron-left"></i>
                            </button>
                            <span class="stepper-value" id="${key}-${prop}-value">${currentValue} / ${maxValue}</span>
                            <button class="stepper-btn" data-key="${key}" data-variant="${isVariant}" data-op="1" title="Next">
                                <i class="fa-solid fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                `;
            }
            
            renderSliderItem(key, item, category) {
                const itemData = this.characterData[this.currentTab]?.[key] || {};
                let controls = '';
                
                for (const mix of item.mixes) {
                    const mixKey = mix.key;
                    const mixLabel = mix.label;
                    const mixValue = itemData[mixKey] || 0.5;
                    controls += `
                        <div class="item-controls-grid">
                            <span class="item-controls-label">${mixLabel}</span>
                            <div class="slider-container">
                                <input type="range" min="0" max="1" step="0.01" value="${mixValue}" 
                                       class="slider" id="${key}-${mixKey}-slider"
                                       data-key="${key}" data-type="${mixKey}">
                            </div>
                        </div>
                    `;
                }

                const itemIcon = this.getItemIcon(key, false);
                
                return `
                    <div class="list-item slider-item" data-key="${key}">
                        <div class="item-header">
                            <span class="item-icon">${itemIcon}</span>
                            <span class="item-label">${item.name}</span>
                        </div>
                        ${controls}
                    </div>
                `;
            }

            renderActionItem(action, label, description) {
                const itemIcon = this.getItemIcon(action, false);
                return `
                    <div class="list-item action-item" data-action="${action}">
                        <span class="item-icon">${itemIcon}</span>
                        <span class="item-label">${label}</span>
                        <div class="item-description">${description}</div>
                    </div>
                `;
            }
            
            getCategoryIcon(categoryKey) {
                const icons = {
                    'basicfeatures': '<i class="fa-solid fa-user"></i>',
                    'facemix': '<i class="fa-solid fa-dna"></i>',
                    'facialfeatures': '<i class="fa-solid fa-eye"></i>',
                    'beauty': '<i class="fa-solid fa-paint-brush"></i>',
                    'hairstyle': '<i class="fa-solid fa-scissors"></i>',
                    'facialhair': '<i class="fa-solid fa-user-tie"></i>',
                    'upperbody': '<i class="fa-solid fa-shirt"></i>',
                    'lowerbody': '<i class="fa-solid fa-person-walking"></i>',
                    'footwear': '<i class="fa-solid fa-shoe-prints"></i>',
                    'accessories': '<i class="fa-solid fa-glasses"></i>',
                    'bags': '<i class="fa-solid fa-bag-shopping"></i>',
                    'actions': '<i class="fa-solid fa-save"></i>',
                    'heritage': '<i class="fa-solid fa-dna"></i>',
                    'bodyshape': '<i class="fa-solid fa-dumbbell"></i>',
                    'head': '<i class="fa-solid fa-skull"></i>',
                    'torso': '<i class="fa-solid fa-dragon"></i>',
                    'leftarm': '<i class="fa-solid fa-sign-language"></i>',
                    'rightarm': '<i class="fa-solid fa-sign-language" style="transform: scaleX(-1);"></i>',
                    'leftleg': '<i class="fa-solid fa-person-running"></i>',
                    'rightleg': '<i class="fa-solid fa-person-running" style="transform: scaleX(-1);"></i>',
                    'pedmodels': '<i class="fa-solid fa-person"></i>'
                };
                return icons[categoryKey.toLowerCase()] || '<i class="fa-solid fa-cog"></i>';
            }

            getItemIcon(itemKey, isVariant) {
                if (isVariant) {
                    return '<i class="fa-solid fa-palette"></i>';
                }

                const icons = {
                    'sex': '<i class="fa-solid fa-venus-mars"></i>',
                    'face': '<i class="fa-solid fa-face-smile"></i>',
                    'skin': '<i class="fa-solid fa-hand"></i>',
                    'heritage': '<i class="fa-solid fa-dna"></i>',
                    'noseWidth': '<i class="fa-solid fa-nose"></i>',
                    'noseHeight': '<i class="fa-solid fa-nose"></i>',
                    'eyebrowHeight': '<i class="fa-solid fa-eye"></i>',
                    'makeup': '<i class="fa-solid fa-paint-brush"></i>',
                    'eyeColor': '<i class="fa-solid fa-eye"></i>',
                    'hair': '<i class="fa-solid fa-scissors"></i>',
                    'beard': '<i class="fa-solid fa-user-tie"></i>',
                    'eyebrow': '<i class="fa-solid fa-eye"></i>',
                    'mask': '<i class="fa-solid fa-mask"></i>',
                    'torso': '<i class="fa-solid fa-shirt"></i>',
                    'arms': '<i class="fa-solid fa-hands"></i>',
                    'pants': '<i class="fa-solid fa-person-walking"></i>',
                    'shoes': '<i class="fa-solid fa-shoe-prints"></i>',
                    'hat': '<i class="fa-solid fa-hat-cowboy"></i>',
                    'glasses': '<i class="fa-solid fa-glasses"></i>',
                    'chain': '<i class="fa-solid fa-gem"></i>',
                    'watch': '<i class="fa-solid fa-watch"></i>',
                    'bag': '<i class="fa-solid fa-bag-shopping"></i>',
                    'heritage_mum': '<i class="fa-solid fa-person-dress"></i>',
                    'heritage_dad': '<i class="fa-solid fa-person"></i>',
                    'body_muscle': '<i class="fa-solid fa-dumbbell"></i>',
                    'body_weight': '<i class="fa-solid fa-weight-scale"></i>',
                    'tattoo_head': '<i class="fa-solid fa-skull"></i>',
                    'tattoo_torso': '<i class="fa-solid fa-dragon"></i>',
                    'tattoo_leftarm': '<i class="fa-solid fa-sign-language"></i>',
                    'tattoo_rightarm': '<i class="fa-solid fa-sign-language"></i>',
                    'tattoo_leftleg': '<i class="fa-solid fa-person-running"></i>',
                    'tattoo_rightleg': '<i class="fa-solid fa-person-running"></i>',
                    'ped': '<i class="fa-solid fa-person"></i>',
                    'saveOutfit': '<i class="fa-solid fa-save"></i>',
                    'loadOutfit': '<i class="fa-solid fa-folder-open"></i>'
                };
                return icons[itemKey] || '<i class="fa-solid fa-circle"></i>';
            }

            updateSelection() {
                const allItems = this.contentArea.querySelectorAll('.list-item');
                allItems.forEach(item => {
                    const { key, variant } = item.dataset;
                    const isSelected = (this.selectedKey === key && (variant === 'true') === this.selectedIsVariant);
                    item.classList.toggle('selected', isSelected);
                });
            }

            updatePrice() {
            }

            async sendNuiMessage(event, data = {}) {
                const resourceName = typeof GetParentResourceName !== 'undefined'
                    ? GetParentResourceName()
                    : 'bastion_character_studio';

                try {
                    const response = await fetch(`https://${resourceName}/${event}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json; charset=UTF-8' },
                        body: JSON.stringify(data)
                    });
                    if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
                    return await response.json();
                } catch (error) {
                    console.log(`[DEV] NUI call: ${event}`, data);
                    return null;
                }
            }

            setupNuiListener() {
                window.addEventListener('message', (event) => {
                    const { action, data } = event.data;
                    
                    switch(action) {
                        case 'openStudio':
                            this.openStudio(data);
                            break;
                        case 'closeStudio':
                            this.closeStudio();
                            break;
                        case 'updateData':
                            this.loadCharacterData(data);
                            break;
                    }
                });
            }

            openStudio(data) {
                if (data.tabs) {
                    this.createTabs(data.tabs);
                }
                if (data.characterData) {
                    this.loadCharacterData(data.characterData);
                }
                if (data.outfits) {
                    this.outfits = data.outfits;
                }
                if (data.pricing) {
                    this.pricing = data.pricing;
                }
                
                this.studio.style.display = 'flex';
                this.switchTab(this.currentTab);
            }

            closeStudio() {
                this.studio.style.display = 'none';
            }

            createTabs(tabKeys) {
                this.tabNavigation.innerHTML = '';
                tabKeys.forEach((key, index) => {
                    const tabData = this.tabs[key];
                    if (!tabData) return;
                    
                    const btn = document.createElement('button');
                    btn.className = 'tab-btn' + (index === 0 ? ' active' : '');
                    btn.dataset.tab = key;
                    btn.textContent = tabData.name;
                    this.tabNavigation.appendChild(btn);
                });
            }

            async saveCharacter() {
                try {
                    const response = await this.sendNuiMessage('saveCharacter', {
                        characterData: this.characterData
                    });
                    
                    if (response && response.success) {
                        this.showStatusMessage('Character saved successfully!', 'success');
                    } else {
                        this.showStatusMessage('Failed to save character', 'error');
                    }
                } catch (error) {
                    console.error('Save failed:', error);
                    this.showStatusMessage('Failed to save character', 'error');
                }
            }

            showStatusMessage(message, type = 'info') {
                const existingMsg = this.contentArea.querySelector('.status-message');
                if (existingMsg) existingMsg.remove();
                
                const msgDiv = document.createElement('div');
                msgDiv.className = `status-message status-${type}`;
                msgDiv.textContent = message;
                this.contentArea.insertBefore(msgDiv, this.contentArea.firstChild);
                
                setTimeout(() => msgDiv.remove(), 3000);
            }

            loadCharacterData(data) {
                this.characterData = data;
                this.renderTabContent(this.currentTab);
            }

            async saveOutfit() {
                const outfitName = prompt('Enter outfit name:');
                if (!outfitName) return;
                
                try {
                    const response = await this.sendNuiMessage('saveOutfit', {
                        name: outfitName,
                        data: this.characterData.clothes || {}
                    });
                    
                    if (response && response.success) {
                        this.showStatusMessage('Outfit saved!', 'success');
                    }
                } catch (error) {
                    this.showStatusMessage('Failed to save outfit', 'error');
                }
            }

            async loadOutfit() {
                if (this.outfits.length === 0) {
                    this.showStatusMessage('No saved outfits', 'warning');
                    return;
                }
                
                const outfitList = this.outfits.map((o, i) => `${i + 1}. ${o.name}`).join('\n');
                const selection = prompt(`Select outfit:\n${outfitList}`);
                const index = parseInt(selection) - 1;
                
                if (index >= 0 && index < this.outfits.length) {
                    const outfit = this.outfits[index];
                    await this.sendNuiMessage('loadOutfit', { data: outfit.data });
                    this.showStatusMessage(`Loaded: ${outfit.name}`, 'success');
                }
            }

            get tabs() {
                return {
                    face: {
                        name: 'Face',
                        categories: {
                            basicFeatures: {
                                name: 'Bird Features',
                                items: {
                                    sex: { name: 'Gender', max: 420, valueLabel: 'Gender' },
                                    face: { name: 'Face Shape', max: 420, valueLabel: 'Shape' },
                                    skin: { name: 'Skin Tone', max: 420, valueLabel: 'Tone' }
                                }
                            },
                            faceMix: {
                                name: 'Face Mixing',
                                items: {
                                    heritage: { 
                                        name: 'Heritage', 
                                        type: 'slider',
                                        mixes: [
                                            { key: 'shapeMix', label: 'Shape' },
                                            { key: 'skinMix', label: 'Skin' }
                                        ]
                                    }
                                }
                            },
                            facialFeatures: {
                                name: 'Facial Features',
                                items: {
                                    noseWidth: { name: 'Nose Width', max: 420, valueLabel: 'Width' },
                                    noseHeight: { name: 'Nose Height', max: 420, valueLabel: 'Height' },
                                    eyebrowHeight: { name: 'Eyebrow Height', max: 420, valueLabel: 'Height' },
                                }
                            },
                            beauty: {
                                name: 'Beauty',
                                items: {
                                    makeup: { name: 'Makeup', max: 420, variant: true, maxVariant: 69, valueLabel: 'Style', variantLabel: 'Opacity' },
                                    eyeColor: { name: 'Eye Color', max: 420, valueLabel: 'Color' }
                                }
                            }
                        }
                    },
                    hair: {
                        name: 'Hair',
                        categories: {
                            hairstyle: {
                                name: 'Hairstyle',
                                items: {
                                    hair: { name: 'Hair Style', max: 420, variant: true, maxVariant: 69, valueLabel: 'Style', variantLabel: 'Color' },
                                }
                            },
                            facialHair: {
                                name: 'Facial Hair',
                                items: {
                                    beard: { name: 'Beard Style', max: 420, variant: true, maxVariant: 69, valueLabel: 'Style', variantLabel: 'Opacity' },
                                    eyebrow: { name: 'Eyebrows', max: 420, variant: true, maxVariant: 69, valueLabel: 'Style', variantLabel: 'Opacity' }
                                }
                            }
                        }
                    },
                    clothes: {
                        name: 'Clothes',
                        categories: {
                            upperBody: {
                                name: 'Upper Body',
                                items: {
                                    mask: { name: 'Mask', max: 420, variant: true, maxVariant: 69, valueLabel: 'Style', variantLabel: 'Color' },
                                    torso: { name: 'Shirt/Jacket', max: 420, variant: true, maxVariant: 69, valueLabel: 'Style', variantLabel: 'Color' },
                                    arms: { name: 'Arms/Sleeves', max: 420, variant: true, maxVariant: 69, valueLabel: 'Style', variantLabel: 'Color' }
                                }
                            },
                            lowerBody: { 
                                name: 'Lower Body', 
                                items: { 
                                    pants: { name: 'Pants', max: 420, variant: true, maxVariant: 69, valueLabel: 'Style', variantLabel: 'Color' } 
                                } 
                            },
                            footwear: { 
                                name: 'Footwear', 
                                items: { 
                                    shoes: { name: 'Shoes', max: 420, variant: true, maxVariant: 69, valueLabel: 'Style', variantLabel: 'Color' } 
                                } 
                            },
                            accessories: {
                                name: 'Accessories',
                                items: {
                                    hat: { name: 'Hat/Helmet', max: 420, variant: true, maxVariant: 69, valueLabel: 'Style', variantLabel: 'Color' },
                                    glasses: { name: 'Glasses', max: 420, variant: true, maxVariant: 69, valueLabel: 'Style', variantLabel: 'Color' },
                                    chain: { name: 'Necklace', max: 420, variant: true, maxVariant: 69, valueLabel: 'Style', variantLabel: 'Color' },
                                    watch: { name: 'Watch', max: 420, variant: true, maxVariant: 69, valueLabel: 'Style', variantLabel: 'Color' }
                                }
                            },
                            bags: { 
                                name: 'Bags', 
                                items: { 
                                    bag: { name: 'Bag', max: 420, variant: true, maxVariant: 69, valueLabel: 'Style', variantLabel: 'Color' } 
                                } 
                            },
                            actions: {
                                name: 'Actions',
                                items: {
                                    save: { name: 'Save Outfit', type: 'action', action: 'saveOutfit', description: 'Save your current clothing setup.' },
                                    load: { name: 'Load Outfit', type: 'action', action: 'loadOutfit', description: 'Load a previously saved outfit.' }
                                }
                            }
                        }
                    },
                    body: {
                        name: 'Body',
                        categories: {
                            heritage: { 
                                name: 'Heritage', 
                                items: {
                                    heritage_mum: { name: 'Mother', max: 420, valueLabel: 'Parent' },
                                    heritage_dad: { name: 'Father', max: 420, valueLabel: 'Parent' }
                                } 
                            },
                            bodyShape: { 
                                name: 'Body Shape', 
                                items: {
                                    body_muscle: { name: 'Muscle Tone', max: 420, valueLabel: 'Tone' },
                                    body_weight: { name: 'Weight', max: 420, valueLabel: 'Weight' }
                                }
                            }
                        }
                    },
                    tattoos: {
                        name: 'Tattoos',
                        categories: {
                            head: { name: 'Head', items: { tattoo_head: { name: 'Head Tattoos', max: 420, valueLabel: 'Tattoo' } } },
                            torso: { name: 'Torso', items: { tattoo_torso: { name: 'Torso Tattoos', max: 420, valueLabel: 'Tattoo' } } },
                            leftArm: { name: 'Left Arm', items: { tattoo_leftarm: { name: 'Left Arm Tattoos', max: 420, valueLabel: 'Tattoo' } } },
                            rightArm: { name: 'Right Arm', items: { tattoo_rightarm: { name: 'Right Arm Tattoos', max: 420, valueLabel: 'Tattoo' } } },
                            leftLeg: { name: 'Left Leg', items: { tattoo_leftleg: { name: 'Left Leg Tattoos', max: 420, valueLabel: 'Tattoo' } } },
                            rightLeg: { name: 'Right Leg', items: { tattoo_rightleg: { name: 'Right Leg Tattoos', max: 420, valueLabel: 'Tattoo' } } }
                        }
                    },
                    ped: {
                        name: 'Ped',
                        categories: {
                            pedModels: {
                                name: 'Bird Models',
                                items: {
                                    ped: { name: 'Bird Model', max: 420, valueLabel: 'Model' }
                                }
                            }
                        }
                    }
                };
            }
        }

        const studio = new CharacterStudio();

		// Auto open for testing type shit
        if (typeof GetParentResourceName === 'undefined') {
            setTimeout(() => {
                window.postMessage({
                    action: 'openStudio',
                    data: {
                        tabs: ['face', 'hair', 'clothes', 'body', 'tattoos', 'ped'],
                        characterData: {
                            face: {
                                sex: { value: 0, variant: 0 },
                                face: { value: 22, variant: 0 },
                                skin: { value: 5, variant: 0 },
                                heritage: { shapeMix: 0.5, skinMix: 0.5 }
                            },
                            clothes: {
                                torso: { value: 15, variant: 0 },
                                pants: { value: 5, variant: 0 }
                            }
                        },
                        outfits: [
                            { name: 'My First Outfit', data: { torso: { value: 1, variant: 2 } } },
                            { name: 'Cop Uniform', data: { torso: { value: 55, variant: 0 } } }
                        ]
                    }
                }, '*');
            }, 500);
        }
    </script>
</body>
</html>
